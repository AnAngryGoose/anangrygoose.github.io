# Docker Management Guide: Homelab Reference

---

## 1. Overview

* **Docker:** A platform that virtualizes the OS, running applications in isolated environments called "containers."
* **Docker Compose:** A declarative tool for defining and managing multi-container applications. It uses a `docker-compose.yml` file to configure services, networks, and volumes for a "project."
* **Docker Volumes:** The preferred mechanism for persisting data generated by and used by Docker containers. Volumes are managed by Docker (`/var/lib/docker/volumes/`) and are decoupled from the container's lifecycle.

---

## 2. Core Strategies: Storage & Networking

I use two distinct patterns for volume and network management.

I'm putting volumes first because it was somewhat hard to understand at first and led to a few lost files.

### 2.1. Volume Management Strategy

Volumes are essential for data persistence. Containers are ephemeral; volumes are persistent. Two types of *named volumes* are utilized, along with specific use cases for *bind mounts*.

#### Strategy 1: Standard (Project-Scoped) Named Volumes

* **Definition:** Volumes are defined in the `docker-compose.yml` file without the `external` flag.
* **Lifecycle:** The volume is created upon the first execution of `docker compose up`. The volume's name is prefixed with the project (directory) name (e.g., `core_portainer_data`).
* **Risk:** This volume is "owned" by the Compose project. Running `docker compose down -v` **will permanently delete this volume and all its data.**
* **Use Case:** Non-critical data, caches, or applications where data is easily reproducible (e.g., `core` stack).

#### Strategy 2: External Named Volumes

* **Definition:** Volumes are created manually *before* running Compose, using `docker volume create <name>`. The `docker-compose.yml` file then references them using `external: true`.
* **Lifecycle:** The volume's lifecycle is **decoupled** from the Compose project. Commands such as `docker compose down -v` can be executed, or the project recreated, without affecting the stored data.
* **Risk:** Low. Data is safe from accidental deletion via Compose commands.
* **Use Case:** **Recommended for all critical data.** (e.g., `omada` stack, `couchdb_data`, `portainer_data`).

#### Strategy 3: Bind Mounts

* **Definition:** Maps a specific file or directory on the Host OS directly to a location inside the container (e.g., `- /mnt/storage:/media`).
* **Use Case:** Essential for accessing massive datasets managed by the host OS (like a MergerFS pool) or passing through specific hardware sockets (`/var/run/docker.sock`).

### 2.2. Network Management Strategy

Containers within a project must be able to communicate.

#### Strategy 1: Default Bridge Network

* **Definition:** By default, Docker Compose creates a new "bridge" network for the project (e.g., `core_default`).
* **Communication:** All services in the `core` project can reach each other by their service name (e.g., `portainer` can ping `homepage`).
* **Isolation:** This network is isolated from the host and other Docker projects. Ports must be explicitly `published` (e.g., `"3000:3000"`) to be accessible from the outside.

#### Strategy 2: Host Network

* **Definition:** Used by `omada-controller` via `network_mode: host`.
* **Communication:** This mode bypasses Docker's networking isolation. The container shares the host's networking namespace.
* **Behavior:** The service binds *directly* to the host's IP address. There is no port mapping; if the service listens on port 8043, it is available on `HOST_IP:8043`.
* **Use Case:** Required by some applications (like Omada) for service discovery. Can offer a slight performance benefit but reduces security and can cause port conflicts on the host.

---

## 3. Homelab Project Structure

This diagram outlines the `docker-compose.yml` files, the services they manage, and the resources they use.

```text
/homelab/docker/
│
├── core/
│   └── docker-compose.yml
│       ├── services:
│       │   ├── portainer
│       │   │   ├── volume:  core_portainer_data (standard)
│       │
│       └── volumes:
│           ├── (Defines standard volumes)
│
├── omada/
│   └── docker-compose.yml
│       ├── services:
│       │   └── omada-controller
│       │       ├── volume:  omada_data (external)
│       │
│       └── volumes:
│           ├── (References external volumes)
│
└── media/
    └── docker-compose.yml
        ├── services:
        │   └── plex
        │       ├── volume: /mnt/storage/media (bind mount)
        │       ├── volume: plex_config (standard)

```

---

## 4. Annotated Compose Examples

These examples demonstrate the three primary storage strategies: Standard Volumes, External Volumes, and Hybrid Bind Mounts.

### 4.1. Standard Volumes (`core/docker-compose.yml`)

*Best for self-contained apps where data is strictly internal to the container.*

```yaml
services:
  portainer:
    image: portainer/portainer-ce:2.20.2
    container_name: portainer
    restart: unless-stopped 
    volumes:
      # --- Volume Definition (Standard) ---
      # This creates a volume managed by Docker.
      # Location: /var/lib/docker/volumes/core_portainer_data/_data
      # WARNING: Deleted if `docker compose down -v` is run.
      - portainer_data:/data
      
      # --- Bind Mount (Socket) ---
      # Special case: mapping a system file
      - /var/run/docker.sock:/var/run/docker.sock
    ports:
      - "9443:9443"

# Volume defined here lets Docker create it automatically
volumes:
  portainer_data:

```

### 4.2. External Volumes (`omada/docker-compose.yml`)

*Best for critical databases where accidental deletion must be impossible.*

```yaml
services:
  omada-controller:
    image: mbentley/omada-controller:latest
    container_name: omada-controller
    restart: always
    network_mode: host
    volumes:
      # --- Volume Definition (External) ---
      # These volumes MUST be created manually first:
      # `docker volume create omada_data`
      - omada_data:/opt/tplink/EAPController/data
      - omada_logs:/opt/tplink/EAPController/logs

# 'external: true' tells Docker "Don't create this, just use it."
# Prevents `docker compose down -v` from deleting the data.
volumes:
  omada_data:
    external: true
  omada_logs:
    external: true

```

### 4.3. Hybrid: Bind Mounts & Named Volumes (`media/docker-compose.yml`)

*Best for media servers (Plex, Jellyfin) where the "content" is huge and exists on the host filesystem, but the "application state" (metadata) is internal.*

```yaml
services:
  plex:
    image: lscr.io/linuxserver/plex:latest
    container_name: plex
    network_mode: host
    environment:
      - PUID=1000
      - PGID=1000
    volumes:
      # --- Bind Mount (Content) ---
      # Maps the host's large storage pool directly to the container.
      # The data resides on the physical disks at /mnt/storage.
      # Format: /host/path:/container/path
      - /mnt/storage/media:/media

      # --- Named Volume (Config) ---
      # Keeps the Plex database (metadata, watch history) in a 
      # fast, Docker-managed volume (usually on the OS SSD).
      - plex_config:/config
    restart: unless-stopped

volumes:
  plex_config:

```

---

## 5. Docker Cheat Sheet

### Docker Compose (Project-level)

*Manages the lifecycle of services in `docker-compose.yml`.*

| Command | Description |
| --- | --- |
| `docker compose up -d` | Start/recreate all services in detached (background) mode. |
| `docker compose down` | Stop and remove all containers, networks. |
| `docker compose down -v` | **DANGER:** Stops, removes containers AND **deletes standard (non-external) volumes.** |
| `docker compose pull` | Pulls the latest images for all services defined in the file. |
| `docker compose logs -f` | Follow (stream) the logs for all services in the project. |

### Docker Volume (Data)

*Manages persistent data volumes.*

| Command | Description |
| --- | --- |
| `docker volume ls` | Lists all named volumes on system. |
| `docker volume create <name>` | **(Manual step for External Volumes)** Creates a new named volume. |
| `docker volume rm <name>` | Deletes a named volume. **Data will be lost.** (Cannot delete if in use). |
| `docker volume inspect <name>` | Shows details about a volume, including its on-disk mountpoint. |

---

## 6. Workflows

### 6.1. Deploying a New Stack

1. **Create Volumes:** Manually create the volumes first.

```bash
docker volume create omada_data
docker volume create omada_logs
```
OR 

`mkdir /docker/project/testfolder1` - for bind mounts (if not already made)

2. **Deploy Stack:**

```bash
docker compose up -d

```
3. **Check it's running**

`docker ps -a`

### 6.2. Backing Up a Volume

This command runs a temporary container to `tar` the contents of a volume into a backup file on the host.

```bash
# Backup 'omada_data' to current directory
docker run --rm \
  -v omada_data:/data:ro \
  -v $(pwd):/backup \
  alpine \
  tar czf /backup/omada_backup.tar.gz -C /data .

```

---

## 7. Official Documentation Links

* **Docker Volumes:** [https://docs.docker.com/storage/volumes/](https://docs.docker.com/storage/volumes/)
* **Bind Mounts:** [https://docs.docker.com/storage/bind-mounts/](https://docs.docker.com/storage/bind-mounts/)
* **Docker Compose File Reference:** [https://docs.docker.com/compose/compose-file/](https://docs.docker.com/compose/compose-file/)
* **Compose `network_mode`:** [https://docs.docker.com/compose/compose-file/05-services/#network_mode](https://docs.docker.com/compose/compose-file/05-services/#network_mode)

---
